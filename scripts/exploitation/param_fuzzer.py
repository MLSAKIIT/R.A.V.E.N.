#!/usr/bin/env python3
"""
param_fuzzer.py - Simple parameter fuzzer for a single URL parameter

Example:
  python3 scripts/exploitation/param_fuzzer.py --url "http://example.com/?id=1" --param id --payloads payloads.txt
"""
from __future__ import annotations
import argparse
import sys
import urllib.parse
try:
    import requests
    HAS_REQUESTS = True
except Exception:
    HAS_REQUESTS = False

GREEN = "\033[1;32m"
YELLOW = "\033[1;33m"
RED = "\033[1;31m"
NC = "\033[0m"


def fetch(url: str, timeout=8) -> tuple[int, str]:
    try:
        if HAS_REQUESTS:
            r = requests.get(url, timeout=timeout)
            return r.status_code, r.text[:2000]
        else:
            import urllib.request
            with urllib.request.urlopen(url, timeout=timeout) as r:
                return r.getcode(), r.read(2000).decode(errors='replace')
    except Exception as e:
        return 0, str(e)


def main() -> int:
    p = argparse.ArgumentParser(description='Parameter fuzzer')
    p.add_argument('--url', required=True)
    p.add_argument('--param', required=True)
    p.add_argument('--payloads', required=True)
    args = p.parse_args()

    try:
        with open(args.payloads, 'r', encoding='utf-8') as fh:
            payloads = [l.strip() for l in fh if l.strip()]
    except Exception as e:
        print(f"{RED}[!] Could not read payloads: {e}{NC}", flush=True)
        return 2

    parsed = urllib.parse.urlparse(args.url)
    qs = dict(urllib.parse.parse_qsl(parsed.query))
    for pld in payloads:
        qs[args.param] = pld
        new_qs = urllib.parse.urlencode(qs)
        u = urllib.parse.urlunparse((parsed.scheme, parsed.netloc, parsed.path, parsed.params, new_qs, parsed.fragment))
        code, body = fetch(u)
        if code == 0:
            print(f"{RED}[!] Error for {pld}: {body}{NC}", flush=True)
            continue
        print(f"{YELLOW}{pld}{NC} -> status={code}", flush=True)

    return 0


if __name__ == '__main__':
    sys.exit(main())
